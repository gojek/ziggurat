name: Ziggurat CI

on:
  push:
    branches:
    tags:
  pull_request:
    branches:
    - master
    - 2.12.7-log4j-patch

jobs:
  run_tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/setup-java@v1
      with:
        java-version: "1.8"
    - uses: DeLaGuardo/setup-clojure@master
      with:
        lein: "2.8.1"
    - uses: actions/checkout@v2

    - name: Run Tests on Kafka Cluster
      run: ./bin/run_tests_ci.sh

  deploy_to_clojars:
    runs-on: ubuntu-latest
    needs:
      [
          run_tests,
      ]
    if: ${{ startsWith(github.ref, 'refs/tags/') }}
    env:
      CLOJARS_USERNAME: ${{ secrets.CLOJARS_USERNAME }}
      CLOJARS_PASSWORD: ${{ secrets.CLOJARS_PASSWORD }}
    steps:
    - uses: actions/setup-java@v1
      with:
        java-version: "1.8"
    - uses: DeLaGuardo/setup-clojure@master
      with:
        lein: "2.8.1"
    - uses: actions/checkout@v2

    - name: Deploy to Clojars
      run: lein deploy clojars

  send_update_event:
    runs-on: ubuntu-latest
    needs: [ deploy_to_clojars ]
    if: ${{ startsWith(github.ref, 'refs/tags/') }}
    steps:
    - uses: peter-evans/repository-dispatch@v1
      with:
        token: ${{secrets.GH_TOKEN}}
        repository: gojek/ziggurat-web
        event-type: ziggurat-release-event